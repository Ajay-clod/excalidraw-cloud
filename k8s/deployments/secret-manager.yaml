# Google Secret Manager Integration
# This file contains examples for integrating Google Secret Manager with GKE
# using External Secrets Operator (ESO)

# Prerequisites:
# 1. Install External Secrets Operator in your cluster
# 2. Enable Workload Identity for your GKE cluster
# 3. Create secrets in Google Secret Manager
# 4. Configure IAM permissions for the service account

---
# Service Account with Workload Identity annotation
# This allows pods to access Google Cloud services securely
apiVersion: v1
kind: ServiceAccount
metadata:
  name: excalidraw-ksa
  namespace: excalidraw
  annotations:
    # TODO: Replace PROJECT_ID with your GCP project ID
    iam.gke.io/gcp-service-account: excalidraw-deployer@PROJECT_ID.iam.gserviceaccount.com
---
# SecretStore pointing to Google Secret Manager
# This tells External Secrets Operator where to fetch secrets
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: gcpsm-secret-store
  namespace: excalidraw
spec:
  provider:
    gcpsm:
      # TODO: Replace with your GCP project ID
      projectID: "your-project-id"
      auth:
        workloadIdentity:
          # TODO: Replace with your cluster location and name
          clusterLocation: us-central1
          clusterName: excalidraw-cluster
          serviceAccountRef:
            name: excalidraw-ksa
---
# ExternalSecret to sync secrets from Google Secret Manager to Kubernetes
# This creates a Kubernetes Secret from Google Secret Manager secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: excalidraw-secrets
  namespace: excalidraw
spec:
  # How often to check for updates
  refreshInterval: 1h
  
  secretStoreRef:
    name: gcpsm-secret-store
    kind: SecretStore
  
  # Target Kubernetes Secret to create/update
  target:
    name: excalidraw-app-secrets
    creationPolicy: Owner
  
  # Map Google Secret Manager secrets to Kubernetes Secret keys
  data:
    # Example: Sync a secret named "excalidraw-api-key" from Secret Manager
    # to a key named "api-key" in the Kubernetes Secret
    - secretKey: api-key
      remoteRef:
        key: excalidraw-api-key
    
    # Example: Redis URL/password
    # - secretKey: redis-url
    #   remoteRef:
    #     key: excalidraw-redis-url
    
    # Example: Database credentials
    # - secretKey: db-password
    #   remoteRef:
    #     key: excalidraw-db-password
    
    # Example: Firebase config
    # - secretKey: firebase-config
    #   remoteRef:
    #     key: excalidraw-firebase-config

---
# Alternative: Traditional Kubernetes Secret (for non-sensitive config or development)
# Create this with: kubectl create secret generic excalidraw-secrets --from-literal=key=value
# apiVersion: v1
# kind: Secret
# metadata:
#   name: excalidraw-manual-secrets
#   namespace: excalidraw
# type: Opaque
# stringData:
#   # Non-sensitive example values
#   api-url: "https://api.example.com"
#   # For actual secrets, use Google Secret Manager instead
