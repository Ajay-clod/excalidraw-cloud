apiVersion: apps/v1
kind: Deployment
metadata:
  name: excalidraw-frontend
  labels:
    app: excalidraw-frontend
    version: v1
spec:
  replicas: 2
  selector:
    matchLabels:
      app: excalidraw-frontend
  template:
    metadata:
      labels:
        app: excalidraw-frontend
        version: v1
    spec:
      # Use dedicated service account for Workload Identity
      # serviceAccountName: excalidraw-ksa
      containers:
        - name: frontend
          # TODO: Update image with your Google Artifact Registry URL
          # Format: REGION-docker.pkg.dev/PROJECT_ID/excalidraw-repo/excalidraw-frontend:TAG
          # Example: us-central1-docker.pkg.dev/my-project/excalidraw-repo/excalidraw-frontend:latest
          image: your-dockerhub/excalidraw-frontend:latest
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 80
              protocol: TCP
          env:
            - name: NODE_ENV
              value: "production"
            # TODO: Update with your WebSocket server URL
            - name: VITE_APP_WS_SERVER_URL
              value: "wss://yjs.your-domain.com"
            # Optional: Load secrets from Google Secret Manager via External Secrets Operator
            # - name: API_KEY
            #   valueFrom:
            #     secretKeyRef:
            #       name: excalidraw-app-secrets
            #       key: api-key
          # Resource requests and limits for efficient pod scheduling
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "500m"
          # Liveness probe to restart unhealthy containers
          livenessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          # Readiness probe to control traffic routing
          readinessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 2
      # Improve pod distribution across nodes
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - excalidraw-frontend
                topologyKey: kubernetes.io/hostname
